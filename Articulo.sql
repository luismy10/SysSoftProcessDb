use [PuntoVentaSysSoftDBDesarrollo]
go

-------------------------------------------------table articulos---------------------------------------------------------------
truncate table ArticuloTB
go

select * from ArticuloTB
go


/*
 dos campos nuevos  Departamento, Inventario 22/11/2018
 dos campos nuevos  Margen,Utilidad,PrecioMayoreo 23//11/2018
 un capo nuevo CantidadGranel 25/11/2018
 eliminado el campo descripcion 29/11/2018
 eliminado el campo modelo 12/12/2018
*/

/*
 agredando campo Imagen 11/12/2018
 combio el campo Image por varchar(MAX) 21/12/2018
 se elimino el campo departamento 5/02/2019
 se elimino el campo precio venta mayoreo 
 Quitado CantidadGranel (15/02/19)
 Actualizado PrecioVenta, Margen y Utilidad a PrecioVenta1, Margen1 y Utilidad1;
 Agregado: 
		  PrecioVenta2, Margen2, Utilidad2;
		  PrecioVenta3, Margen3, Utilidad3  21/02/2019	
 Se quiero
	descripcion
*/

/*
	compra
		-leche
	produccion interna
		-
*/

create table ArticuloTB
(
	IdArticulo varchar(12) primary key not null,
	Origen int not null,
	Clave varchar(45) not null,
	ClaveAlterna varchar(45) null,
	NombreMarca varchar(120) not null,
	NombreGenerico varchar(120) null,
	--Descripcion varchar(200) null,
	Categoria int null,
	Marca int null,
	Presentacion int,
	UnidadCompra int,
	UnidadVenta tinyint,
	--Departamento int,
	--Localizacion int,
	Estado int,
	StockMinimo decimal(18,4),
	StockMaximo decimal(18,4),
	Cantidad decimal(18,4),
	--CantidadGranel decimal(18,2),
	PrecioCompra decimal(18,4),	

	PrecioVentaGeneral decimal(18,4),	
	PrecioMargenGeneral smallint,
	PrecioUtilidadGeneral decimal(18,4),

	--PrecioVentaMayoreo decimal(18,2),	
	--MargenMayoreo smallint,
	--UtilidadMayoreo decimal(18,2),	
	Lote bit,
	Inventario bit,
	Imagen varchar(MAX)
	--Serie bit,
)
go

TRUNCATE TABLE ArticuloTB
GO
TRUNCATE TABLE KardexArticuloTB
GO
TRUNCATE TABLE PreciosTB
GO

select * from ArticuloTB
go
select * from KardexArticuloTB
go
select * from PreciosTB
go

update ArticuloTB set ArticuloTB.IdSuministro = SuministroTB.IdSuministro
from SuministroTB,ArticuloTB
where SuministroTB.Clave = ArticuloTB.Clave
go

SELECT * FROM KardexArticuloTB
GO


create table PreciosTB
(
	IdPrecios int identity not null,
	IdArticulo varchar(12) not null,
	IdSuministro varchar(12) not null,
	Nombre varchar(30) not null,
	Valor decimal(18,4) not null,
	Factor decimal(18,4) not null
	primary key(IdPrecios)
)
go

}
/*
este procedimiento procedimiento
0almacenado esta en
deprecate
drop procedure Sp_Crud_Articulo
@IdArticulo varchar(12),
@Clave varchar(45),
@ClaveAlterna varchar(45),
@NombreMarca varchar(120),
@NombreGenerico varchar(120),
@Descripcion varchar(200),
@Categoria int,
@Marca int,
@Presentacion int,
@StockMinimo decimal(18,2),
@StockMaximo decimal(18,2),
@PrecioCompra decimal(18,2),
@PrecioVenta decimal(18,2),
@Estado int,
@Lote bit,
-------------------------------
@Imagen varbinary(MAX),
-------------------------------
@Message varchar(20) out
as
	begin
		begin try
			begin transaction
				if exists(select * from ArticuloTB where IdArticulo = @IdArticulo)
					begin
						if exists(select * from ArticuloTB where IdArticulo <> @IdArticulo and Clave = @Clave )
							begin
								rollback
								set @Message = 'duplicate'
							end
						else
							begin
								update ArticuloTB set Clave = @Clave,ClaveAlterna=@ClaveAlterna,
								NombreMarca=UPPER(@NombreMarca),NombreGenerico=UPPER(@NombreGenerico),
								Descripcion=UPPER(@Descripcion),Categoria=@Categoria,Marca=@Marca,Presentacion=@Presentacion,
								StockMinimo=@StockMinimo,StockMaximo=@StockMaximo,PrecioCompra=@PrecioCompra,
								PrecioVenta=@PrecioVenta,Estado=@Estado,Lote=@Lote
								where IdArticulo = @IdArticulo
								commit
								set @Message = 'updated'
							end
						
					end
				else 
					begin
						if exists(select * from ArticuloTB where Clave = @Clave)
							begin
								rollback
								set @Message = 'duplicate'
							end
						else
							begin
								declare @idGenerado varchar(12)
								set @idGenerado = dbo.Fc_Articulo_Codigo_Alfanumerico()
								insert into ArticuloTB(IdArticulo,Clave,ClaveAlterna,NombreMarca,NombreGenerico,Descripcion,Categoria,Marca,Presentacion,
								StockMinimo,StockMaximo,PrecioCompra,PrecioVenta,Cantidad,Estado,Lote)
								values(@idGenerado,@Clave,@ClaveAlterna,UPPER(@NombreMarca),UPPER(@NombreGenerico),UPPER(@Descripcion),@Categoria,@Marca,@Presentacion,
								@StockMinimo,@StockMinimo,@PrecioCompra,@PrecioVenta,0,@Estado,@Lote)
								
								insert into ImagenTB(Imagen,IdRelacionado)
								values(@Imagen,@idGenerado)
								
								insert into HistorialArticuloTB(IdArticulo,FechaRegistro,TipoOperacion,Entrada,Salida,Saldo,UsuarioRegistro)
								values('7878',GETDATE(),'Alta de Artículo',0,0,0,'')
								commit
								set @Message = 'registered'
							end
						
					end				
		end try
		begin catch
			rollback
			set @Message='error'
		end catch
	end
go
*/

/*
	Eliminado campo CantidadGranel 21/02/19
	Actualizado campos PrecioVenta, Margen y Utilidad a PrecioVenta1, Margen1 y Utilidad1 21/02/19
	Agregado campos PrecioVenta2, Margen2, Utilidad2, PrecioVenta3, Margen3 y Utilidad3 21/02/19
*/
alter procedure Sp_Get_Articulo_By_Id
@IdArticulo varchar(45)
as
	begin
		select IdArticulo,Origen,Clave,ClaveAlterna,NombreMarca,NombreGenerico,
		Categoria,dbo.Fc_Obtener_Nombre_Detalle(Categoria,'0006') as CategoriaNombre,
		Marca,dbo.Fc_Obtener_Nombre_Detalle(Marca,'0007') as MarcaNombre,
		Presentacion,dbo.Fc_Obtener_Nombre_Detalle(Presentacion,'0008') as PresentacionNombre,
		UnidadCompra,dbo.Fc_Obtener_Nombre_Detalle(UnidadCompra,'0013') as UnidadCompraNombre,
		UnidadVenta,
		StockMinimo,StockMaximo,Cantidad,PrecioCompra,PrecioVentaGeneral,PrecioMargenGeneral,PrecioUtilidadGeneral,
		Estado,Lote,Inventario,Imagen,
		Impuesto,dbo.Fc_Obtener_Nombre_Impuesto(Impuesto) as ImpuestoNombre
		from ArticuloTB
		where IdArticulo=@IdArticulo or Clave = @IdArticulo
	end
go


CREATE function [dbo].[Fc_Obtener_Nombre_Impuesto]
	(
	 @IdImpuesto int
	)
	RETURNS VARCHAR(50)
	AS
	BEGIN
		DECLARE @Result VARCHAR(50)
			BEGIN
				SET @Result = (SELECT Nombre FROM ImpuestoTB WHERE IdImpuesto = @IdImpuesto)	
			END
			RETURN @Result
	END
go



/*
este procedimiento procedimiento
almacenado esta en
deprecate
drop procedure Sp_Get_Articulo_By_Id_View
@IdArticulo varchar(12)
as
	begin
		select NombreMarca,NombreGenerico,PrecioVenta,Cantidad
		from ArticuloTB
		where IdArticulo=@IdArticulo
	end
go
*/


alter procedure Sp_Listar_Inventario_Articulos
as
	select
	IdArticulo,Clave,NombreMarca,PrecioCompra,
	Cantidad,
	dbo.Fc_Obtener_Nombre_Detalle(UnidadCompra,'0013') as UnidadCompra,
	dbo.Fc_Obtener_Nombre_Detalle(Estado,'0001') as Estado,
	(PrecioCompra*Cantidad) as Total 
	from ArticuloTB 
	where Inventario = 1 order by Total desc
go




/*
	Eliminado campo CantidadGranel 21/02/19
	Actualizado Campo PrecioVenta a PrecioVenta1 21/02/19
*/
[dbo].[Sp_Listar_Articulo] 0,'',0
go

ALTER procedure [dbo].[Sp_Listar_Articulo]
@option tinyint,
@search varchar(100),
@categoria int
as
	begin	
			select IdArticulo,Clave,ClaveAlterna,NombreMarca,NombreGenerico,
			dbo.Fc_Obtener_Nombre_Detalle(Marca,'0007') as Marca,
			Cantidad,
			PrecioVentaGeneral,
			Impuesto,
			dbo.Fc_Obtener_Nombre_Detalle(UnidadCompra,'0013') as UnidadCompraNombre,
			UnidadVenta,
			dbo.Fc_Obtener_Nombre_Detalle(Categoria,'0006') as Categoria,
			dbo.Fc_Obtener_Nombre_Detalle(Estado,'0001') as Estado,
			Imagen	
			from ArticuloTB 
			where (@option = 0) 
			OR (Categoria=@categoria AND @option = 1) 
			OR (NombreMarca LIKE @search +'%' AND @option = 2)	
			OR (
				(Clave = @search AND @option = 3)
				OR 
				(ClaveAlterna = @search AND @option = 3)
			   )
			  
	end
go

alter procedure Sp_Listar_Articulo_Paginacion
@paginacion int
as
	begin	
			select IdArticulo,Clave,ClaveAlterna,NombreMarca,NombreGenerico,
			dbo.Fc_Obtener_Nombre_Detalle(Marca,'0007') as Marca,
			Cantidad,
			PrecioVentaGeneral,
			Impuesto,
			dbo.Fc_Obtener_Nombre_Detalle(UnidadCompra,'0013') as UnidadCompraNombre,
			UnidadVenta,
			dbo.Fc_Obtener_Nombre_Detalle(Categoria,'0006') as Categoria,
			dbo.Fc_Obtener_Nombre_Detalle(Estado,'0001') as Estado,
			Imagen	
			from ArticuloTB 
			
			   order by IdArticulo asc
			   offset @paginacion rows fetch next 10 rows only
	end
go


select * from ArticuloTB 
go

select * from ArticuloTB 
ORDER BY IdArticulo ASC
OFFSET 0 ROWS FETCH NEXT 10 ROWS ONLY
go

create procedure Sp_Listar_Articulo_Movimiento
@IdArticulo varchar(45)
as
	begin
		select IdArticulo,Clave,NombreMarca,Cantidad,dbo.Fc_Obtener_Nombre_Detalle(UnidadCompra,'0013') as UnidadCompraNombre,PrecioCompra,PrecioVentaGeneral,
		Inventario,ValorInventario 
		from ArticuloTB
		where 
		IdArticulo = @IdArticulo
	end
go

/*
	Eliminado campo CantidadGranel 21/02/19
	Actualizado Campo PrecioVenta a PrecioVenta1 21/02/19
drop procedure Sp_Listar_Articulo_Categoria
@Categoria int
as
	begin
			select IdArticulo,Clave,NombreMarca,
			dbo.Fc_Obtener_Nombre_Detalle(Marca,'0007') as Marca,
			Cantidad,
			PrecioVenta1,
			UnidadVenta,
			dbo.Fc_Obtener_Nombre_Detalle(Categoria,'0006') as Categoria,
			dbo.Fc_Obtener_Nombre_Detalle(Estado,'0001') as Estado,
			Imagen	
			from ArticuloTB 
					
			order by NombreMarca asc
	end
go
*/

/*
	Actualizado campo PrecioVenta a PrecioVenta1 21/02/19
	Agregado campos: PrecioVentaNombre1, Margen1, Utilidad1,
					 PrecioVentaNombre2, PrecioVenta2, Margen2, Utilidad2,
					 PrecioVentaNombre3, PrecioVenta3, Margen3 y Utilidad3
*/

select NombreMarca from ArticuloTB
go

execute sp_helpindex 'ArticuloTB'
go

create nonclustered index INONCLUS_ARTICULO_CLAVE
on ArticuloTB(Clave)
go
create nonclustered index INONCLUS_ARTICULO_NOMBRE_MARCA
on ArticuloTB(NombreMarca)
go

select * from ImpuestoTB
go

ALTER procedure Sp_Listar_Articulo_Lista_View
@opcion tinyint,
@search varchar(100)
as
	begin
		select IdArticulo,Clave,NombreMarca,dbo.Fc_Obtener_Nombre_Detalle(Marca,'0007') as Marca,
		Cantidad,PrecioCompra,
		PrecioVentaGeneral,PrecioMargenGeneral,PrecioUtilidadGeneral,UnidadVenta,
		dbo.Fc_Obtener_Nombre_Detalle(UnidadCompra,'0013') as UnidadCompra,Inventario,Impuesto,Lote,ValorInventario,		
		case
			when Origen = 1 then 'COMPRA'
			when Origen = 2 then 'PRODUCCIÓN'
			when Origen = 3 then 'SUB. PRODUCTO(S)'
		end as Origen
		from ArticuloTB 
		where 
		(
			(@opcion = 1 and @search = '' and Estado = 1) 
			or
			(@opcion = 1 and Clave = @search and Estado = 1 )
			or
			(@opcion = 1 and ClaveAlterna = @search and Estado = 1 )
			or
			(@opcion = 1 and NombreMarca like @search +'%' and Estado = 1)
		)
		or(
			(@opcion = 2 and @search = '' and Estado = 1 and Origen = 3) 
			or
			(@opcion = 2 and Clave = @search and Estado = 1 and Origen = 3)
			or
			(@opcion = 2 and ClaveAlterna = @search and Estado = 1 and Origen = 3)
			or
			(@opcion = 2 and NombreMarca like @search +'%' and Estado = 1 and Origen = 3)
		)
	end

go


alter procedure Sp_Listar_Articulo_By_Search 'AT0003'
@search varchar(60)
as
	begin
		select IdArticulo,Clave,NombreMarca,dbo.Fc_Obtener_Nombre_Detalle(Marca,'0007') as Marca,
		dbo.Fc_Obtener_Nombre_Detalle(Presentacion,'0008') as Presentacion ,
		Cantidad,PrecioCompra,PrecioVentaGeneral,
		UnidadVenta,Lote,Inventario,Impuesto,ValorInventario
		from ArticuloTB 
		where Clave = @search
	end
go

select * from ArticuloTB
go


alter function Fc_Articulo_Codigo_Alfanumerico ()  returns varchar(12)
	as
		begin
		declare @Length int,@Incremental int,@ValorActual varchar(12),@ValorNuevo varchar(12),@CodGenerado varchar(12)
			begin
				if EXISTS(select IdArticulo from ArticuloTB)
					begin					
						set @ValorActual = (select MAX(CAST(REPLACE(REPLACE(IdArticulo,'AT',''),'','')AS INT)) from ArticuloTB)
						set @Incremental = CONVERT(INT,@ValorActual) +1						
						if(@Incremental <= 9)
							begin
								set @CodGenerado = 'AT000'+CONVERT(VARCHAR,@Incremental)
							end
						else if(@Incremental>=10 and @Incremental<=99)
							begin
								set @CodGenerado = 'AT00'+CONVERT(VARCHAR,@Incremental)
							end
						else if(@Incremental>=100 and @Incremental<=999)
							begin
								set @CodGenerado = 'AT0'+CONVERT(VARCHAR,@Incremental)
							end
						else
							begin
								set @CodGenerado = 'AT'+CONVERT(VARCHAR,@Incremental)
							end
					end
				else
					begin
						set @CodGenerado = 'AT0001'
					end
			end
			return @CodGenerado
		end
go

alter procedure Sp_Generar_Listardo_CodBar
@UnidadVenta tinyint,
@Categoria int
as
	begin
		SELECT Clave,ClaveAlterna,NombreMarca,UnidadVenta,Categoria
         FROM ArticuloTB
		 WHERE (@UnidadVenta = 0 and @Categoria = 0) 
		 or 
		 (UnidadVenta = @UnidadVenta and @Categoria = 0) 
		 or
		 (UnidadVenta = @UnidadVenta and Categoria = @Categoria) 
		 or
		 (@UnidadVenta = 0 and Categoria = @Categoria) 
	end
go

------------------------------------------------------------------------------------------------------------------------

----------------------------------------------kardex del artículo-------------------------------------------------------


create table KardexArticuloTB
(
	IdKardex int identity(1,1) not null,
	IdArticulo varchar(12) not null,
	Fecha date not null,
	Hora time not null,
	Tipo tinyint not null,
	Movimiento int not null,
	Detalle varchar(100) not null,
	Cantidad decimal(18,4) not null,
	CUnitario decimal(18,4) not null,
	CTotal decimal(18,4) not null,
	primary key(IdKardex,IdArticulo)
)
go

alter procedure Sp_Listar_Kardex_Articulo_By_Id 
@idArticulo varchar(45)
as
SELECT k.IdArticulo,k.Fecha,k.Hora,k.Tipo,t.Nombre,
k.Detalle,k.Cantidad,k.CUnitario,k.CTotal
 FROM KardexArticuloTB AS k INNER JOIN ArticuloTB AS a ON k.IdArticulo = a.IdArticulo
 inner join TipoMovimientoTB AS t ON k.Movimiento = t.IdTipoMovimiento
WHERE 
	(a.IdArticulo = @idArticulo )
	or
	(a.Clave = @idArticulo or a.ClaveAlterna = @idArticulo)
	order by k.Fecha,k.Hora asc
GO

truncate table KardexArticuloTB
go

select * from KardexArticuloTB
go

select * from ArticuloTB
go



------------------------------------------------------------------------------------------------------------------------

----------------------------------------------Mivimiento -------------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                